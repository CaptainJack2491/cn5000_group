--1

SELECT CLASS_TYPE AS CLASS_LIST,
(SELECT FIRST_NAME ||' '|| LAST_NAME FROM STAFF WHERE STAFF_ID = FITNESS_CLASSES.INSTRUCTOR_ID) AS INSTRUCTOR_NAME, 
TO_CHAR(SCHEDULE,'DD-MON-YYYY HH24:MI') AS SCHEDULE
FROM FITNESS_CLASSES
ORDER BY CLASS_LIST;

--2

SELECT CLIENTS.FIRST_NAME || ' ' || CLIENTS.LAST_NAME AS CLIENT_NAME, CLASS_BOOKINGS.STATUS
FROM FITNESS_CLASSES
JOIN CLASS_BOOKINGS ON FITNESS_CLASSES.CLASS_ID = CLASS_BOOKINGS.CLASS_ID
JOIN CLIENTS ON CLASS_BOOKINGS.CLIENT_ID = CLIENTS.CLIENT_ID
WHERE FITNESS_CLASSES.CLASS_TYPE = 'Yoga';

--3

SELECT SUM(AMOUNT) AS TOTAL_REVENUE
FROM BILLING
WHERE SERVICE_NAME IN ('Membership', 'Class Booking', 'Personal Training');

--4

SELECT TRAINER_ID, COUNT(TRAINING_ID) AS SESSIONS_TAKEN
FROM PERSONAL_TRAINING_SESSIONS
GROUP BY TRAINER_ID
ORDER BY TRAINER_ID
FETCH FIRST 5 ROWS ONLY;

--5

SELECT CL.FIRST_NAME || ' ' || CL.LAST_NAME AS CLIENT_NAME, CL.CLIENT_ID
FROM GYM_ATTENDANCE GA
JOIN MEMBERSHIP MEM ON MEM.CLIENT_ID = GA.CLIENT_ID
JOIN CLIENTS CL ON GA.CLIENT_ID = CL.CLIENT_ID
WHERE MEM.END_DATE < SYSDATE AND GA.CHECK_IN > SYSDATE - 30;

--6

SELECT CL.FIRST_NAME || ' ' || CL.LAST_NAME AS CLIENT_NAME, COUNT(PTS.EXERCISE_TYPE) AS EXERCISES
FROM PERSONAL_TRAINING_SESSIONS PTS
JOIN CLIENTS CL ON CL.CLIENT_ID = PTS.CLIENT_ID
WHERE CL.CLIENT_CATEGORY = 'Member'
GROUP BY CL.FIRST_NAME, CL.LAST_NAME
HAVING COUNT(PTS.EXERCISE_TYPE) >= 3
ORDER BY EXERCISES DESC;

--7
SELECT DISCOUNT_CODE, USAGE_COUNT, REVENUE_LOSS
FROM DISCOUNTS
ORDER BY REVENUE_LOSS;

--8

SELECT 
    CL.FIRST_NAME || ' ' || CL.LAST_NAME AS CLIENT_NAME, 
    CL.GYM_VISITS, 
    TRUNC(100 * (GYM_VISITS/22)) || '%' AS PROGRESS,
    (
        SELECT LISTAGG(TO_CHAR(GA.CHECK_IN, 'DD-MM-YYYY'), ', ') WITHIN GROUP (ORDER BY GA.CHECK_IN)
        FROM GYM_ATTENDANCE GA
        WHERE GA.CLIENT_ID = CL.CLIENT_ID
    ) AS VISIT_DATES
FROM CLIENTS CL;    

SELECT 
    CL.FIRST_NAME || ' ' || CL.LAST_NAME AS CLIENT_NAME, 
    CL.GYM_VISITS, 
    TRUNC(100 * (CL.GYM_VISITS / 22)) || '%' AS PROGRESS,
    TO_CHAR(GA.CHECK_IN, 'DD-MM-YYYY') AS VISIT_DATE
FROM CLIENTS CL
JOIN GYM_ATTENDANCE GA 
    ON CL.CLIENT_ID = GA.CLIENT_ID
ORDER BY CLIENT_NAME, GA.CHECK_IN;


--UNRELEATED QUERY

SELECT 
    CLIENT_ID, 
    TO_CHAR(CHECK_IN, 'DD-MM-YYYY') AS REPEATED_DATE,
    COUNT(*) AS OCCURRENCES
FROM GYM_ATTENDANCE
GROUP BY CLIENT_ID, TO_CHAR(CHECK_IN, 'DD-MM-YYYY')
HAVING COUNT(*) > 1
ORDER BY CLIENT_ID, REPEATED_DATE;



--testing
SELECT 
    CL.FIRST_NAME || ' ' || CL.LAST_NAME AS CLIENT_NAME, 
    CL.GYM_VISITS, 
    TRUNC(100 * (GYM_VISITS/22)) || '%' AS PROGRESS,
    (
        SELECT LISTAGG(TO_CHAR(GA.CHECK_IN, 'DD-MM-YYYY'), ', ') WITHIN GROUP (ORDER BY GA.CHECK_IN)
        FROM GYM_ATTENDANCE GA
        WHERE GA.CLIENT_ID = CL.CLIENT_ID
        AND GA.CHECK_IN BETWEEN SYSDATE - 30 AND SYSDATE
    ) AS VISIT_DATES
FROM CLIENTS CL
-- JOIN GYM_ATTENDANCE GA ON CL.CLIENT_ID = GA.CLIENT_ID
WHERE  EXISTS (
    SELECT 1 
    FROM GYM_ATTENDANCE GA
    WHERE GA.CLIENT_ID = CL.CLIENT_ID 
      AND GA.CHECK_IN BETWEEN SYSDATE - 30 AND SYSDATE
);
-- GA.CHECK_IN BETWEEN SYSDATE - 30 AND SYSDATE -30

 -- (
    --     SELECT LISTAGG(TO_CHAR(GA.CHECK_IN, 'DD-MM-YYYY'), ', ') WITHIN GROUP (ORDER BY GA.CHECK_IN)
    --     FROM GYM_ATTENDANCE GA
    --     WHERE GA.CLIENT_ID = CL.CLIENT_ID
    --     AND GA.CHECK_IN BETWEEN SYSDATE - 30 AND SYSDATE
    -- ) AS VISIT_DATES


-- comparing query
SELECT 
    CL.FIRST_NAME || ' ' || CL.LAST_NAME AS CLIENT_NAME, 
    NVL(
        (SELECT COUNT(*)
         FROM GYM_ATTENDANCE GA1
         WHERE GA1.CLIENT_ID = CL.CLIENT_ID
           AND GA1.CHECK_IN BETWEEN SYSDATE - 30 AND SYSDATE), 0
    ) AS previous_30_days_visits,
    NVL(
        (SELECT COUNT(*)
         FROM GYM_ATTENDANCE GA2
         WHERE GA2.CLIENT_ID = CL.CLIENT_ID
           AND GA2.CHECK_IN BETWEEN SYSDATE - 60 AND SYSDATE - 31), 0
    ) AS earlier_30_days_visits,
    NVL(
        (SELECT COUNT(*)
         FROM GYM_ATTENDANCE GA1
         WHERE GA1.CLIENT_ID = CL.CLIENT_ID
           AND GA1.CHECK_IN BETWEEN SYSDATE - 30 AND SYSDATE), 0
    ) -
    NVL(
        (SELECT COUNT(*)
         FROM GYM_ATTENDANCE GA2
         WHERE GA2.CLIENT_ID = CL.CLIENT_ID
           AND GA2.CHECK_IN BETWEEN SYSDATE - 60 AND SYSDATE - 31), 0
    ) AS difference_in_visits,
    TRUNC(
        100 *
        NVL(
            (SELECT COUNT(*)
             FROM GYM_ATTENDANCE GA1
             WHERE GA1.CLIENT_ID = CL.CLIENT_ID
               AND GA1.CHECK_IN BETWEEN SYSDATE - 30 AND SYSDATE), 0
        ) / 22
    ) || '%' AS progress
FROM CLIENTS CL
WHERE EXISTS (
    SELECT 1
    FROM GYM_ATTENDANCE GA
    WHERE GA.CLIENT_ID = CL.CLIENT_ID
      AND GA.CHECK_IN BETWEEN SYSDATE - 60 AND SYSDATE
);
